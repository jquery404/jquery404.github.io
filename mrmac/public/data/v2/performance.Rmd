---
title: "Performance"
author: "jQuery404"
output: html_notebook
---

Beautify

```{r}
library(reshape2)
library(ggplot2)
library(dplyr)
library(lubridate)

coloring = c("#E76469", "#F8D85E","#EDA645","#D1B0B3","#8C99A6","#ADD299","#4FA490","#3B7F9F")
fontsize = 14
```


System performance based on the `Capturing/Processing Time`, `Encoding/Decoding Time`, `Transmission Time`, `Network Latency`, `Rendering FPS`

```{r}
# Set up the data
metrics <- c('Capturing/Processing Time', 
             'Encoding/Decoding Time', 
             'Transmission Time', 
             'Network Latency', 
             'Rendering FPS')
values <- list(c(45, 5, 50, 53, 80), c(60, 15, 60, 80, 65))

# Set up custom sorting order
custom_order <- c('Capturing/Processing Time', 
                  'Encoding/Decoding Time', 
                  'Transmission Time', 
                  'Network Latency',
                  'Rendering FPS')

# Create a data frame
data <- data.frame(metric = factor(rep(metrics, 2), levels = custom_order),
                   value = unlist(values),
                   test = factor(rep(c("MRMAC", "AVT"), each = length(metrics)), levels = c("AVT", "MRMAC")))

# Create the chart
ggplot(data, aes(x = value, y = metric, fill = test)) +
  geom_col(position = position_dodge(width = .65), width = .45) +
  scale_y_discrete(expand = c(0, 1)) +
  scale_fill_manual(values = c("AVT" = "#F8D85E", "MRMAC" = "#E76469")) +
  #labs(title = "System Performance Chart", x = "Time in ms or FPS", y = "System Performance Metrics") +
  theme_bw() + 
  theme(axis.line = element_blank(),
        axis.title.x=element_blank(),
        axis.title.y=element_blank(),
        axis.text.x = element_text(color="black", size=fontsize),
        axis.text.y = element_text(color="black", size=fontsize),
        text = element_text(size=fontsize),
        strip.background = element_blank(),
        plot.background = element_blank(),
        plot.margin = unit(c(0.005, .025, 0, 0), "null"),
        panel.border = element_blank(),
        panel.spacing = unit(c(0, 0, 0, 0), "null"),
        #panel.grid.major = element_blank(),
        legend.position = c(.95, 0.4),
        legend.justification = c("right", "top"),
        legend.title=element_blank(),
        legend.text=element_text(size=fontsize),
        legend.box.just = "right",
        legend.box.background = element_rect(fill = "white", color = "black", size = 1))



# Save the chart as a PDF file
ggsave("out/performance.pdf", width = 10, height = 5, unit = "in", dpi = 300)
```



Stacking system performance parameters in the horizontal stack-bar plot 

```{r}
dat <- read.table(text = "A   B   C
1 48 780 431
2 720 350 377
3 460 480 179
4 220 240 876", header = TRUE)


dat$row <- seq_len(nrow(dat))
dat2 <- melt(dat, id.vars = "row")


ggplot(dat2, aes(x = variable, y = value, fill = row)) + 
  geom_bar(stat = "identity") +
  xlab("\nType") +
  ylab("Time\n") +
  coord_flip() +
  theme_bw()
```

Following generates a Time series and show the latency over a time period


```{r}
# Generate sample data
set.seed(42)
sample_size <- 1000
timestamps <- seq(from = as.POSIXct("2023-01-01 00:00:00"), by = "10 min", length.out = sample_size)
latencies <- runif(sample_size, min = 10, max = 500)

data <- data.frame(timestamp = timestamps, latency = latencies)

# Convert the timestamp column to a proper date-time format
data$timestamp <- as.POSIXct(data$timestamp, format="%Y-%m-%d %H:%M:%S")

# Calculate the average, minimum, and maximum latency per time period (e.g., per hour)
latency_summary_data <- data %>%
  group_by(time_period = floor_date(timestamp, "hour")) %>%
  summarise(avg_latency = mean(latency, na.rm = TRUE),
            min_latency = min(latency, na.rm = TRUE),
            max_latency = max(latency, na.rm = TRUE))

# Create the combined latency chart using ggplot2
ggplot() +
  geom_linerange(data = latency_summary_data, aes(x = time_period, ymin = min_latency, ymax = max_latency), color = "gray", alpha = 0.5) +
  geom_line(data = latency_summary_data, aes(x = time_period, y = avg_latency), color = "blue") +
  geom_point(data = latency_summary_data, aes(x = time_period, y = avg_latency), color = "blue") +
  labs(title = "End-to-End Latency",
       x = "Time Period",
       y = "Latency (ms)") +
  theme_minimal()
```



```{r}

df <- read.csv('csv/performance.csv', sep=",")
category_order <- c("e", "d", "c", "b", "a")
role_order <- c("AR", "VR")
# Reshape the data to long format
df_long <- tidyr::pivot_longer(df, cols = -role, names_to = "category", values_to = "value")
df_long$role <- factor(df_long$role, levels = role_order)
df_long$category <- factor(df_long$category, levels = category_order)

# Create the stacked bar chart
ggplot(df_long, aes(x = value, y = role, fill = category)) +
  geom_col(position = "stack", width = 0.5) +
  scale_fill_manual(
    values = c("#E76469", "#F8D85E","#EDA645","#D1B0B3","#8C99A6","#ADD299","#4FA490","#3B7F9F"),
    labels = c("a" = "360 Video Capture", "b" = "Encoding/Decoding", "c" = "Network Transmission", "d" = "Network Latency", "e" = "Annotation"),
    breaks = rev(category_order)) +
  guides(fill = guide_legend(nrow = 2))+
  theme_bw() +
  theme(axis.line = element_blank(),
        
        axis.title.y=element_blank(),
        axis.text.x = element_text(color="black", size=fontsize),
        axis.text.y = element_text(color="black", size=fontsize),
        text = element_text(size=fontsize),
        strip.background = element_blank(),
        plot.background = element_blank(),
        plot.margin = unit(c(0.005, .025, 0, 0), "null"),
        panel.border = element_blank(),
        panel.spacing = unit(c(0, 0, 0, 0), "null"),
        legend.position = "bottom",
        legend.justification = c("center", "center"),
        legend.title=element_blank(),
        legend.key.width = unit(.75, "cm"), 
        legend.text=element_text(size=fontsize),
        legend.box.just = "center") +
  scale_x_continuous(name="Time taken for each process (ms)", breaks = seq(0, 500, by = 50))

ggsave("out/performance.pdf", width = 7, height = 2.5, dpi = 1000)

```


## Latency might vary based on the number of users in an SFU WebRTC setup


```{r}
# create data
data=read.csv('csv/latency.csv', sep=",")

g <- ggplot(data=data, aes(x=A, y=B, group=1)) +
  geom_area(fill = coloring[1],
            alpha = 0.2,
            color = coloring[1],
            lwd = 0.5, 
            linetype = 1)+
  geom_point(color=coloring[1])

g + 
  theme_bw() + 
  theme(axis.line = element_blank(),
        axis.text.x = element_text(color="black", size=fontsize),
        axis.text.y = element_text(color="black", size=fontsize),
        strip.text = element_blank(),
        strip.background = element_blank(),
        panel.border = element_blank(),
        panel.grid.minor.x = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        plot.background = element_blank(),
        plot.margin = unit(c(0.005, .025, 0, 0), "null"),
        panel.spacing = unit(c(0, 0, 0, 0), "null"),
        legend.position = "none") +
  scale_x_continuous(name="Number of users", breaks = seq(1, 20, by = 1)) +
  scale_y_continuous(name="Latency (ms)", breaks=seq(0, 1000, by=150))

ggsave("out/latency.pdf", width = 6, height = 2, dpi = 1000)
```


```{r}
df=read.csv('csv/2latency.csv', sep=",")
custom_colors <- c("#E76469", "#055CF2")
rank_order <- c("AR", "VR")
# Plot the points and lines
g <- ggplot(df) +
  geom_point(aes(x = users, y = vr, color = "VR"), show.legend = FALSE) +
  geom_point(aes(x = users, y = ar, color = "AR"), show.legend = FALSE) +
  geom_line(aes(x = users, y = vr, color = "VR"), show.legend = FALSE) +
  geom_line(aes(x = users, y = ar, color = "AR"), show.legend = FALSE) +
  geom_area(aes(x = users, y = vr, fill = "VR"), alpha = 0.2, show.legend = TRUE) +
  geom_area(aes(x = users, y = ar, fill = "AR"), alpha = 0.2, show.legend = TRUE) +
  labs(color = "Legend Title", fill = "Legend Title") + 
  scale_fill_manual(values = custom_colors, breaks = rev(rank_order), 
                    labels = c("VR" = "Number of VR-Traveler", "AR" = "Number of AR-Host")) + 
  scale_color_manual(values = custom_colors, breaks = rev(rank_order),
                     labels = c("VR" = "Number of VR-Traveler", "AR" = "Number of AR-Host"))

g + 
  theme_bw() + 
  theme(axis.line = element_blank(),
        axis.text.x = element_text(color="black", size=fontsize),
        axis.text.y = element_text(color="black", size=fontsize),
        strip.text = element_blank(),
        strip.background = element_blank(),
        panel.border = element_blank(),
        panel.grid.minor.x = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        plot.background = element_blank(),
        plot.margin = unit(c(0.005, .025, 0, 0), "null"),
        panel.spacing = unit(c(0, 0, 0, 0), "null"),
        legend.title=element_blank(),
        legend.text=element_text(size=fontsize*.7),
        legend.box.just = "left",
        legend.position = c(0.25, 0.99),
        legend.direction = "vertical",
        legend.justification = c("center", "top")) +
  scale_x_continuous(name="Number of users", breaks = seq(1, 20, by = 1)) +
  scale_y_continuous(name="Latency (ms)", breaks=seq(0, 1000, by=150))

ggsave("out/2latency.pdf", width = 6, height = 2, dpi = 1000)
```

