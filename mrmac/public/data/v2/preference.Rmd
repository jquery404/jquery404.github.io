---
title: "Preference"
author: "jQuery404"
output: html_notebook
---


```{r}
library(ggplot2)
library(dplyr)
library(ggpubr)
library(reshape2)

coloring = c("#E76469", "#F8D85E","#EDA645","#D1B0B3","#8C99A6","#ADD299","#4FA490","#3B7F9F")
fontsize = 14

preferences <- data.frame(
  Condition = c("H1", "H2", "H3", "H4"),
  R1 = c(2, 4, 1, 3), # Change these values to match the actual rankings in the study
  R2 = c(4, 3, 2, 1), # Change these values to match the actual rankings in the study
  R3 = c(3, 2, 4, 1), # Change these values to match the actual rankings in the study
  R4 = c(1, 2, 3, 4) # Change these values to match the actual rankings in the study
)

```


## Stacked bars within grouped barchart

```{r}
data=read.csv('csv/preference.csv', sep=",")

p <- ggplot(data, aes(x = conditions, y = score, fill = rank)) + 
  geom_bar(stat = 'identity', position = 'stack') + 
  coord_flip() +
  theme_bw()


p + facet_grid(rows = vars(qus),  switch = "y") + theme(strip.placement = "outside")
```

## Multiple Questions with 3 conditions rank

```{r}
data=read.csv('csv/preference.csv', sep=",")

p <- ggplot(data, aes(x = conditions, y = score, fill = rank)) + 
  geom_bar(stat = 'identity', position = 'stack') + 
  coord_flip() +
  theme_bw()

# Add labels to bars
p <- p + geom_text(aes(label = score), position = position_stack(vjust = 0.5), color = "black", size = 4)

# Add facet grid
p <- p + facet_grid(rows = vars(qus), switch = "y") + 
  # geom_signif(annotations = "*", y_position = 36.5, xmin="C1", xmax="C2") +
  theme(strip.placement = "outside",
        strip.background = element_rect(fill=coloring[3], color = NA))

# Apply the custom colors to the fill color of each factor level
p <- p + scale_fill_manual(values = coloring)

# Add theme elements
p <- p + theme(axis.title.x=element_blank(),
               axis.title.y = element_blank(), 
               plot.margin = unit(c(0, .05, .5, 0), "null"),
               panel.border = element_blank(),
               strip.text = element_text(face = "bold"),
               legend.title=element_blank(),
               legend.direction="horizontal",
               legend.position = c(.5,-.05),
               legend.justification = c("center", "top"))

# Show the plot
p

# saving the final figure
ggsave("out/preference.pdf", width = 7, height = 4, dpi = 1000)
```
## Adding different annotation to each facet in ggplot

```{r}
data=read.csv('csv/preference.csv', sep=",")

anno <- data.frame(x1 = c(1.75, 0.75), x2 = c(2.25, 1.25), 
                   y1 = c(36, 36), y2 = c(37, 37), 
                   xstar = c(2, 1), ystar = c(38, 38),
                   lab = c("***", "**"),
                   region = c("q1", "q2"))


p <- ggplot(data, aes(x = conditions, y = score, fill = rank)) + 
  geom_bar(stat = 'identity', position = 'stack') + 
  coord_flip() +
  theme_bw()

# Add labels to bars
p <- p + geom_text(aes(label = score), position = position_stack(vjust = 0.5), color = "black", size = 4)

p <- p + geom_text(data = anno, aes(x = xstar,  y = ystar, label = lab))

# Add facet grid
p <- p + facet_grid(rows = vars(qus), switch = "y") + 
  theme(strip.placement = "outside",
        strip.background = element_rect(fill=coloring[3], color = NA))

# Apply the custom colors to the fill color of each factor level
p <- p + scale_fill_manual(values = coloring)

# Add theme elements
p <- p + theme(axis.title.x=element_blank(),
               axis.title.y = element_blank(), 
               plot.margin = unit(c(0, 0, .5, 0), "null"),
               panel.border = element_blank(),
               legend.title=element_blank(),
               legend.direction="horizontal",
               legend.position = c(.5,-.05),
               legend.justification = c("center", "top"))

# Show the plot
p
```


## Preference breakdown based on Friedman + Kendall + Nemenyi test

```{r}
# Load necessary libraries
library(FSA)        # For the Nemenyi test
library(PMCMRplus)  # For the Nemenyi test

# Input data
scenario_A <- matrix(c(2, 1, 3, 4, 5,
                       1, 3, 5, 2, 4,
                       4, 5, 2, 1, 3),
                     nrow = 3, byrow = TRUE)

# Perform the Friedman test
friedman_result <- friedman.test(scenario_A)
print(friedman_result)

# Calculate Kendall's W
num_raters <- nrow(scenario_A)
num_objects <- ncol(scenario_A)
kendall_chi <- friedman_result$statistic / (sum(scenario_A)^2 - sum(scenario_A)^3 / (length(scenario_A) + 1))
print(kendall_chi)
kendall_w <- (12 * friedman_result$statistic) / (num_raters * num_objects * (num_objects + 1))
print(kendall_w)


# Convert matrix to long data frame format
scenario_A_long <- expand.grid(Rater = factor(1:nrow(scenario_A)), Object = factor(1:ncol(scenario_A)))
scenario_A_long$Rank <- as.vector(t(scenario_A))
# Perform post-hoc pairwise comparisons using the Nemenyi test
nemenyi_result <- frdAllPairsNemenyiTest(Rank ~ Object | Rater, data = scenario_A_long)
print(nemenyi_result)
```




## geom_signif

```{r}
#create data frame
df <- data.frame(team=rep(c('A', 'B', 'C'), each=3),
                 position=rep(c('Guard', 'Forward', 'Center'), times=3),
                 points=c(3, 2, 1, 1, 3, 2, 1, 2, 3))

ggplot(df, aes(fill=position, y=points, x=team)) + 
  geom_bar(position='stack', stat='identity') + 
  geom_signif(comparisons = list(c("B", "A"),
                                 c("B", "C"),
                                 c("C", "A")),
              test = "t.test", step_increase = 0.15, y_position= 6.1,
              map_signif_level = c("***", "**", "*")) +
  ylim(0, 7) +
  coord_flip()
```


## Save the resulting data frame as a CSV file

```{r}
write.csv(data, file = "out/data.csv", row.names = FALSE)
```
