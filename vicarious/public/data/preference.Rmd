---
title: "Preference"
author: "jQuery404"
output: html_notebook
---


```{r}
library(ggplot2)
library(dplyr)
library(ggpubr)
library(reshape2)

coloring = c("#537b7f", "#94d8e0", "#f6dbb8", "#ffbd67")
fontsize = 14
textsize = 7
dodge = .75
```


```{r}
df_melt=read.csv('csv/preference.csv', sep=",")

custom_order <- c("AS", "GS", "MS", "NS")
custom_order2 <- c("Q6", "Q5", "Q4", "Q3", "Q2", "Q1")

df_melt$cond <- factor(df_melt$cond, levels = custom_order)
df_melt$qus <- factor(df_melt$qus, levels = custom_order2)

plt <- ggplot(df_melt, aes(x = qus, y = value, fill = cond)) +
  geom_bar(position = "fill", stat = "identity", color = "black", size = 0.5) + 
  geom_text(aes(label = sprintf("%1.0f", value)), size = textsize, 
            position = position_fill(vjust = 0.5)) +
  scale_y_continuous(labels = scales::percent_format()) +
  scale_fill_manual(values = coloring) +
  labs(x = NULL, y = NULL) +
  coord_flip() + 
  theme_bw() +
  theme(
    axis.line = element_blank(),
    axis.title.x=element_blank(),
    axis.title.y=element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.text.y = element_text(color="black", size=fontsize),
    text = element_text(size=fontsize),
    strip.background = element_blank(),
    plot.background = element_blank(),
    plot.margin = unit(c(0.005, .025, 0, 0), "null"),
    panel.border = element_blank(),
    panel.grid.major.x = element_blank(),
    panel.spacing = unit(c(0, 0, 0, 0), "null"),
    legend.position="bottom",
    legend.direction = "horizontal",
    legend.justification = c("center", "top"),
    legend.title=element_blank(),
    legend.text=element_text(size=fontsize),
    legend.box.just = "right",
    legend.box.background = element_blank()
  ) +
  guides(fill = guide_legend(reverse = TRUE))

# Create a table to show on the plot
my_table <- data.frame(
  ID = c("Q1", "Q2", "Q3", "Q4", "Q5", "Q6"),
  Questions = c(
    "Which condition did you find easiest to use?",
    "Which condition did you find most helpful for understanding the task environment?",
    "Which condition did you find most helpful for understanding your partner's instructions?",
    "Which condition did you find most effective for communicating with your partner?",
    "Which condition did you find most helpful for completing the task?",
    "Which condition did you prefer the most?"
  )
)

my_table_grob <- tableGrob(my_table, cols = NULL, rows=NULL)

final_plot <- arrangeGrob(plt, my_table_grob, nrow = 2, heights = c(0.8, 0.5))

# Display the plot
grid.arrange(final_plot)

# saving the final figure
ggsave("out/preference.pdf", final_plot, width = 8, height = 5, dpi = 1000)

```



### Lets plot 
bar plot

```{r}
df_melt=read.csv('csv/preference.csv', sep=",")

custom_order <- c("AS", "GS", "MS", "NS")
custom_order2 <- c("Q6", "Q5", "Q4", "Q3", "Q2", "Q1")
custom_order <- rev(custom_order)
custom_order2 <- rev(custom_order2)

df_melt$cond <- factor(df_melt$cond, levels = custom_order)
df_melt$qus <- factor(df_melt$qus, levels = custom_order2)

bp <- ggplot(df_melt, aes(x = qus, y = value, fill = cond)) +
      geom_bar(stat = "identity", position = position_dodge(1.15*dodge), width = 1*dodge, color = "black") +
      geom_text(aes(label = value), position = position_dodge(width = 1.15*dodge), vjust = -0.5, size = 5) +
      scale_fill_manual(values = coloring) +
      theme_bw() +
      ylim(0, 20) +
      theme(axis.line = element_blank(),
        axis.title.x=element_blank(),
        axis.title.y=element_blank(),
        axis.text.x = element_text(color="black", size=fontsize),
        axis.text.y = element_text(color="black", size=fontsize),
        text = element_text(size=fontsize),
        strip.background = element_blank(),
        plot.background = element_blank(),
        plot.margin = unit(c(0.005, .025, 0, 0), "null"),
        panel.border = element_blank(),
        panel.spacing = unit(c(0, 0, 0, 0), "null"),
        legend.position="bottom",
        legend.direction = "horizontal",
        legend.justification = c("center", "top"),
        legend.key.size = unit(1, "cm"),
        legend.title=element_blank(),
        legend.text=element_text(size=fontsize),
        legend.box.just = "right",
        legend.box.background = element_blank())

# Create a table to show on the plot
my_table <- data.frame(
  ID = c("Q1", "Q2", "Q3", "Q4", "Q5", "Q6"),
  Questions = c(
    "Which condition did you find easiest to use?",
    "Which condition did you find most helpful for understanding the task environment?",
    "Which condition did you find most helpful for understanding your partner's instructions?",
    "Which condition did you find most effective for communicating with your partner?",
    "Which condition did you find most helpful for completing the task?",
    "Which condition did you prefer the most?"
  )
)

my_table_grob <- tableGrob(my_table, cols = NULL, rows=NULL)
final_plot <- arrangeGrob(bp, my_table_grob, nrow = 2, heights = c(0.8, 0.5))

# Display the plot
grid.arrange(final_plot)

# saving the final figure
ggsave("out/preference.pdf", final_plot, width = 8, height = 5, dpi = 1000)
```
VR and AR separate

```{r}
# Load required packages
library(ggplot2)
library(gridExtra)
library(cowplot)
library(grid)

custom_barplot <- function(df, tag, dodge, fontsize, coloring) {
  ggplot(df, aes(x = qus, y = value, fill = cond)) +
  geom_bar(stat = "identity", position = position_dodge(1.15*dodge), width = 1*dodge, color = "black") +
  geom_text(aes(label = value), position = position_dodge(width = 1.15*dodge), vjust = -0.5, size = 5) +
  scale_fill_manual(values = coloring) +
  ylim(0, 15) +
  ylab(NULL) +
  labs(tag = tag) +
  geom_vline(xintercept=c(0.5,1.5,2.5,3.5,4.5,5.5,6.5),color="#F2F2F2")+ 
  annotation_custom(grid::linesGrob(y = c(0,0), gp = grid::gpar(lwd=3))) +
  theme_bw() +
  theme(
    axis.line = element_blank(),
    axis.title.x=element_blank(),
    axis.title.y=element_text(face = "bold", size = fontsize),
    axis.text.x = element_blank(),
    axis.text.y = element_text(color="black", size=fontsize),
    text = element_text(size=fontsize),
    strip.background = element_blank(),
    plot.background = element_blank(),
    plot.tag = element_text(angle = 90, vjust = 1, size=fontsize),
    plot.tag.position = c(1, .5),
    plot.margin = unit(c(0.0, .025, .0, 0), "null"),
    panel.grid.major.x = element_blank(),
    panel.grid.major.y = element_blank(),
    panel.border = element_blank(),
    panel.spacing = unit(c(0, 0, 0, 0), "null"),
    legend.position="null",
    legend.direction = "horizontal",
    legend.justification = c("center", "top"),
    legend.key.size = unit(1, "cm"),
    legend.title=element_blank(),
    legend.text=element_text(size=fontsize),
    legend.box.just = "right",
    legend.box.background = element_blank()
  )
}

df_pref_vr=read.csv('csv/preference_vr.csv', sep=",")
df_pref_ar=read.csv('csv/preference_ar.csv', sep=",")

custom_order <- c("AS", "GS", "MS", "NS")
custom_order2 <- c("Q6", "Q5", "Q4", "Q3", "Q2", "Q1")
custom_order <- rev(custom_order)
custom_order2 <- rev(custom_order2)

df_pref_vr$cond <- factor(df_melt$cond, levels = custom_order)
df_pref_vr$qus <- factor(df_melt$qus, levels = custom_order2)
df_pref_ar$cond <- factor(df_melt$cond, levels = custom_order)
df_pref_ar$qus <- factor(df_melt$qus, levels = custom_order2)

# Create the first plot
plotvr <- custom_barplot(df_pref_vr, "remote user", dodge, fontsize, coloring)

# Create the second plot
plotar <- custom_barplot(df_pref_ar, "local user", dodge, fontsize, coloring) +
          theme(
            plot.tag.position = c(1, .7),
            axis.title.x=element_blank(),
            axis.text.x = element_text(color="black", size=fontsize),
            legend.position="bottom"
          )

# Create a table to show on the plot
my_table <- data.frame(
  ID = c("Q1", "Q2", "Q3", "Q4", "Q5", "Q6"),
  Questions = c(
    "Which condition did you find easiest to use?",
    "Which condition did you find most helpful for understanding the task environment?",
    "Which condition did you find most helpful for understanding your partner's instructions?",
    "Which condition did you find most effective for communicating with your partner?",
    "Which condition did you find most helpful for completing the task?",
    "Which condition did you prefer the most?"
  )
)

mytheme <- gridExtra::ttheme_default(
    core = list(fg_params=list(cex = 1.2)),
    colhead = list(fg_params=list(cex = 1.0)),
    rowhead = list(fg_params=list(cex = 1.0)))

my_table_grob <- gridExtra::tableGrob(my_table, cols = NULL, rows=NULL, theme = mytheme)
for (i in 1:6) {
  my_table_grob$grobs[i][[1]][["gp"]] <- gpar(fontsize=15) #$, fontface="normal"
}
grid.draw(my_table_grob)

# my_table_grob <- tableGrob(my_table, cols = NULL, rows=NULL)

final_plot <- arrangeGrob(plotvr, plotar, my_table_grob, nrow = 3, heights = c(.3, .4, .3))
# plot_grid(plotvr, plotar, my_table_grob, finalalign = "v", nrow = 3, rel_heights = c(1/2, 1/2, 1/6))

# Display the plot
grid.arrange(final_plot)
ggsave("out/preference1.pdf", final_plot, width = 8, height = 6, dpi = 1000)
```

```{r}
library("MASS")  
data(crabs)  
melt_crabs <- melt(crabs,id.var=c("sp","sex","index"))   
ggplot(melt_crabs, aes(x = variable, y = value)) +   
  geom_line(aes(group = index), size = 0.05, alpha = 0.7) +   
  geom_boxplot(aes(fill = sp), alpha = 0.5) + 
  facet_grid(sex~.)
```



### Chi-square stuffs
#### Chi-Square Goodness-of-Fit Test: determine if these observed frequencies significantly differ from the expectations. This test compares the observed frequencies to the expected frequencies under the assumption that there is no association between preference and the conditions.
  - H0: The observed distribution of viewpoint conditions matches the expected distribution.
  - HA: The observed distribution of viewpoint conditions differs from the expected distribution.


```{r}
df=read.csv('csv/pref.chi.csv', sep=",")

print_chi_test <- function(qus_no, test_results) {
  cat(qus_no, ". Chi-square test statistic:", test_results$test_statistic, "\n")
  cat("p-value:", test_results$p_value, "\n")
  cat("residual:", test_results$residual, "\n")
  cat("Significant categories contributing to the chi-square result:", test_results$significant_cat, "\n")
  cat("---------------------------------\n")
}

chi_square_test <- function(observed) {
  expected <- rep(1 / length(observed), length(observed)) # 0.25 0.25 0.25 0.25 (equal distribution)
  # Perform chi-square goodness-of-fit test
  result <- chisq.test(observed, p = expected)
  residuals <- residuals(result)
  significant_categories <- which(abs(residuals) > 1.96) 
  
  test_statistic <- result$statistic
  p_value <- result$p.value
  results <- list(
    test_statistic = test_statistic,
    p_value = p_value,
    residual = abs(residuals),
    significant_cat = significant_categories
  )
  return(results)
}


Q1 <- df[1:2, ] 
Q1[, c("NS", "MS", "GS", "AS")] <- lapply(Q1[, c("NS", "MS", "GS", "AS")], as.numeric)
Q1sums <- colSums(Q1[, c("NS", "MS", "GS", "AS")])
test_results <- chi_square_test(Q1sums)
print_chi_test("Q1", test_results)


Q2 <- df[4:5, ] 
Q2[, c("NS", "MS", "GS", "AS")] <- lapply(Q2[, c("NS", "MS", "GS", "AS")], as.numeric)
Q2sums <- colSums(Q2[, c("NS", "MS", "GS", "AS")])
test_results <- chi_square_test(Q2sums)
print_chi_test("Q2", test_results)


Q3 <- df[7:8, ]
Q3[, c("NS", "MS", "GS", "AS")] <- lapply(Q3[, c("NS", "MS", "GS", "AS")], as.numeric)
Q3sums <- colSums(Q3[, c("NS", "MS", "GS", "AS")])
test_results <- chi_square_test(Q3sums)
print_chi_test("Q3", test_results)


Q4 <- df[10:11, ]
Q4[, c("NS", "MS", "GS", "AS")] <- lapply(Q4[, c("NS", "MS", "GS", "AS")], as.numeric)
Q4sums <- colSums(Q4[, c("NS", "MS", "GS", "AS")])
test_results <- chi_square_test(Q4sums)
print_chi_test("Q4", test_results)


Q5 <- df[13:14, ]
Q5[, c("NS", "MS", "GS", "AS")] <- lapply(Q5[, c("NS", "MS", "GS", "AS")], as.numeric)
Q5sums <- colSums(Q5[, c("NS", "MS", "GS", "AS")])
test_results <- chi_square_test(Q5sums)
print_chi_test("Q5", test_results)


Q6 <- df[16:17, ]
Q6[, c("NS", "MS", "GS", "AS")] <- lapply(Q6[, c("NS", "MS", "GS", "AS")], as.numeric)
Q6sums <- colSums(Q6[, c("NS", "MS", "GS", "AS")])
test_results <- chi_square_test(Q6sums)
print_chi_test("Q6", test_results)

```

#### Chi-Square Test of Independence: investigate if there is an association between user roles (VR, AR) and viewpoint condition types (NS, MS, GS, AS). We want to determine if there is a significant relationship between user roles and viewpoint types in preference.
  - H0: user role and viewpoint condition type are independent (no association).
  - HA: user role and viewpoint condition type are not independent (there is an association).

```{r}
# TODO
```


```{r}
df=read.csv('csv/pref.chi.csv', sep=",")

print_chi_test <- function(qus_no, test_results) {
  cat(qus_no, ". Chi-square test statistic:", test_results$test_statistic, "\n")
  cat("p-value:", test_results$p_value, "\n")
  cat("residual:", test_results$residual, "\n")
  cat("Significant categories contributing to the chi-square result:", test_results$significant_cat, "\n")
  cat("---------------------------------\n")
}
```
