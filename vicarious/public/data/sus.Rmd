---
title: "SUS"
output: html_notebook
---
```{r}
library(ggplot2)
library(ggpubr)
library(afex)
library(ggResidpanel)
library(psych)
library(emmeans)
library(ARTool)
library(rstatix)
library(gridExtra)
library(grid)

coloring = c("#ffbd67", "#f6dbb8","#94d8e0","#537b7f")
fontsize = 14
dodge = .75
```

#### Normality test
  - 80.3 or higher = good, 
  - 68 and above = average, 
  - 51 and above = OK and
  - below 51 = poor

```{r}
df=read.csv('csv/sus.csv', sep=",")

summary_df <- df %>%
  group_by(role) %>%
  summarise(mean = mean(sus_score),
            # min = min(sus_score),
            # max = max(sus_score),
            # median = median(sus_score),
            sd = sd(sus_score)) %>%
  mutate(rating = case_when(
    mean >= 80.3 ~ "good",
    mean >= 68 ~ "average",
    mean >= 51 ~ "ok",
    TRUE ~ "poor"
  ))


# Print the summary
print(summary_df)

df %>%
  group_by(role, conditions) %>%
  shapiro_test(sus_score) %>%
  mutate(sig = ifelse(p < 0.05, "*", ""))

qqnorm(df$sus_score);qqline(df$sus_score)

ggqqplot(df, "sus_score", ggtheme = theme_bw()) + facet_grid(conditions~role)

hist(df$sus_score)
```


#### Quick box-plot

```{r}
df=read.csv('csv/sus.csv', sep=",")
condition_order <- c("NS", "MS", "GS", "AS")
df$conditions <- factor(df$conditions, levels = condition_order)
boxplot(sus_score ~ conditions, data = df, 
        main = "Boxplot Example",
        xlab = "Category",
        ylab = "Value")
# Calculate mean for each category
means <- aggregate(sus_score ~ conditions, data = df, mean)
points(x = as.numeric(means$conditions), y = means$sus_score, pch = 4)

ggplot(df, aes(x = conditions, y = sus_score)) +
  geom_boxplot() +
  labs(title = "Boxplot Example", x = "Category", y = "Value") +
  facet_grid(. ~ role)
```
#### ART

```{r}
df=read.csv('csv/sus.csv', sep=",")
condition_order <- c("NS", "MS", "GS", "AS")
role_order <- c("VR", "AR") 
df$conditions <- factor(df$conditions, levels = condition_order)
df$role <- factor(df$role, levels = role_order)

m = art(sus_score ~ conditions * role + (1|participant), data = df)
anova(m)

shapiro.test(residuals(m))
qqnorm(residuals(m));qqline(residuals(m))


# contrast test
art.con(m, ~ conditions) %>%
  summary() %>%
  mutate(sig = ifelse(p.value < 0.05, "*", ""))

art.con(m, ~ role) %>%
  summary() %>%
  mutate(sig = ifelse(p.value < 0.05, "*", ""))

art.con(m, "conditions:role", interaction = TRUE) %>%
  summary() %>%
  mutate(sig = ifelse(p.value < 0.05, "*", ""))


```


SUS data is normally distributed, one-way ANOVA to compare the means of the SUS scores between the different conditions. 

```{r}
model <- aov_4(sus_score ~ conditions + (conditions|participant), type= 3, data = df)
summary(model)

print('# Perform repeated measures ANOVA with nice()')
modelnice <- nice(model, intercept = TRUE, correction = "GG")

print(modelnice) # ges: generalized eta-squared, measure of effect size indicating the proportion of variance explained by the independent variable.

emmip(model, ~conditions, CIs = TRUE)
```
```{r}
posthoc <- emmeans(model, specs = pairwise ~ conditions, model = "multivariate", adjust = "tukey")
posthoc$emmeans
posthoc$contrasts
```

```{r}
model <- aov_4(sus_score ~ conditions*vr_ar + (conditions|participant), type= 3, data = df)
summary(model)

print('# Perform repeated measures ANOVA with nice()')
modelnice <- nice(model, intercept = TRUE, correction = "GG")
# ges: generalized eta-squared, measure of effect size indicating the proportion of variance explained by the independent variable.
print(modelnice)

print('# Posthoc')
posthoc <- emmeans(model, specs = pairwise ~ conditions*vr_ar, model = "multivariate", adjust = "tukey") # tukey/bonferroni
posthoc$emmeans
posthoc$contrasts


emmip(model, vr_ar~conditions, CIs = TRUE)
```


Extract residual/predicted values
```{r}
new_data <- fitted(model, append = TRUE)
residual_data <- residuals(model, append = TRUE)
new_data$.residuals <- residual_data$.residuals
head(new_data, 20)

describe(new_data$.residuals, type=1)

shapiro.test(new_data$.residuals)

resid_auxpanel(residuals=new_data$.residuals, predicted=new_data$.fitted, smoother = TRUE, qqbands=TRUE, 
               plots=c('resid', 'qq', 'index', 'hist'))
```

Based on the ANOVA table, the p-value (0.327) is greater than the significance level of 0.05, suggesting that there is no significant evidence to reject the null hypothesis. This indicates that there are no significant differences observed between the conditions in terms of the SUS scores.


```{r}
df=read.csv('csv/sus.csv', sep=",")
condition_order <- c("NS", "MS", "GS", "AS")
df$conditions <- factor(df$conditions, levels = condition_order)

x_order <- c("VR", "AR")
df$role <- factor(df$role, levels = x_order)

stats <- df %>%
  group_by(role) %>%
  wilcox_test(sus_score~conditions, p.adjust.method = 'holm', paired = TRUE) %>%
  add_significance("p") %>%
  add_xy_position(x = "params")

tukey <- df %>% 
  tukey_hsd(sus_score ~ role) %>% 
  add_significance() %>% 
  add_xy_position()

bxp <- ggplot(df, aes(x = role, y = sus_score)) + 
  stat_boxplot(aes(fill = conditions), geom = "errorbar", width = 0.2, position = position_dodge(dodge)) +
  geom_boxplot(aes(fill = conditions), width = dodge, coef = 0, outlier.alpha = 0, show.legend = F) +
  stat_summary(aes(fill = conditions), fun.y = mean, 
               geom= "point", shape = 4, size = 5, colour= "black", 
               position = position_dodge(width = dodge)) +
  stat_summary(aes(fill = conditions), fun = median,
               geom = "crossbar", fatten = .1, width = .4*dodge, color = "black",
               position = position_dodge(width = dodge)) +
  labs(x = NULL, y = NULL) + 
  scale_fill_manual(name= "conditions", values = coloring) +
  scale_color_manual(name = "conditions", values = coloring) +
  stat_pvalue_manual(stats, label = 'p.adj.signif', hide.ns = TRUE, tip.length = 0.02) +
  scale_y_continuous(minor_breaks = seq(0, 115, 20), breaks = seq(0, 100, by=20), limits=c(0, 100)) +
  annotation_custom(grid::linesGrob(y = c(0,0), gp = grid::gpar(lwd=3))) +
  geom_vline(xintercept=c(0.5,1.5,2.5,3.5,4.5,5.5,6.5,7.5),color="#F2F2F2")+ 
  theme_bw() + 
  theme(
    axis.line = element_blank(),
    axis.title.x=element_blank(),
    axis.title.y=element_blank(),
    axis.text.x = element_text(color="black", size=fontsize),
    axis.text.y = element_text(color="black", size=fontsize),
    text = element_text(size=fontsize),
    strip.background = element_blank(),
    plot.background = element_blank(),
    plot.margin = unit(c(0.005, .025, 0, 0), "null"),
    panel.border = element_blank(),
    panel.spacing = unit(c(0, 0, 0, 0), "null"),
    panel.grid.major.x = element_blank(),
    legend.key = element_blank(),
    legend.key.size = unit(1, "cm"),
    legend.key.height = unit(1.5, 'cm'), 
    legend.key.width = unit(1, 'cm'), 
    legend.position="none",
    legend.direction = "horizontal",
    legend.justification = c("center", "top"),
    legend.title=element_blank(),
    legend.text=element_text(size=fontsize),
    legend.box.just = "right",
    legend.box.background = element_blank()
  ) + 
  guides(fill = guide_legend(override.aes = list(color = "transparent")))

bxp
# saving the final figure
ggsave("out/sus.pdf", width = 6, height = 4, dpi = 1000)

```


```{r}
df=read.csv('csv/sus.csv', sep=",")
condition_order <- c("NS", "MS", "GS", "AS")
df$conditions <- factor(df$conditions, levels = condition_order)

# Create boxplot using ggplot
p <- ggplot(df, aes(x = conditions, y = sus_score)) +
  stat_boxplot(geom = "errorbar", width = 0.2) +
  geom_boxplot(aes(fill = conditions)) +
  stat_summary(fun.y = mean, geom="point", shape = 4, size = 3) +  
  labs(x = NULL, y = NULL) + 
  theme_bw()

# Add significance bars
p <- p + 
  stat_compare_means(
    comparisons = list(
      c("NS", "MS"), c("MS", "GS"), c("NS", "GS"), 
      c("GS", "AS"), c("NS", "AS"), c("MS", "AS")
    ),
    method = "t.test",
    exact = FALSE,
    p.adjust.method = "bonferroni",
    label = "p.signif",
    size = 3,
    label.x.npc = "left",
    label.y.npc = "top"
  )
p + 
  scale_fill_manual(name= "conditions", values = coloring) +
  theme(
    axis.line = element_blank(),
    axis.title.x=element_blank(),
    axis.title.y=element_blank(),
    axis.text.x = element_text(color="black", size=fontsize),
    axis.text.y = element_text(color="black", size=fontsize),
    text = element_text(size=fontsize),
    strip.background = element_blank(),
    plot.background = element_blank(),
    plot.margin = unit(c(0.005, .025, 0, 0), "null"),
    panel.border = element_blank(),
    panel.spacing = unit(c(0, 0, 0, 0), "null"),
    legend.position="bottom",
    legend.direction = "horizontal",
    legend.justification = c("center", "top"),
    legend.title=element_blank(),
    legend.text=element_text(size=fontsize),
    legend.box.just = "right",
    legend.box.background = element_blank()
  )
```
VR--AR

```{r}
custom_boxplot <- function(df, dodge, fontsize, coloring, tag) {
  ggplot(df, aes(x = conditions, y = sus_score)) + 
    stat_boxplot(aes(fill = conditions), geom = "errorbar", width = 0.2, position = position_dodge(dodge)) +
    geom_boxplot(aes(fill = conditions), width = dodge, coef = 0, outlier.alpha = 0, show.legend = F) +
    stat_summary(aes(fill = conditions), fun.y = mean, 
                 geom= "point", shape = 4, size = 3, colour= "black", 
                 position = position_dodge(width = dodge)) +
    stat_summary(aes(fill = conditions), fun = median,
                 geom = "crossbar", fatten = .1, width = dodge, color = "black",
                 position = position_dodge(width = dodge)) +
    labs(x = NULL, y = NULL) + 
    theme_bw() + 
    stat_pvalue_manual(tukey, hide.ns = T) +
    scale_fill_manual(name= "conditions", values = coloring) +
    scale_color_manual(name = "conditions", values = coloring) +
    scale_y_continuous(minor_breaks = seq(0, 115, 20), breaks = seq(0, 115, by=20), limits=c(0, 115)) +
    ylim(0, 100) +
    labs(tag = tag) +
    annotation_custom(grid::linesGrob(y = c(0,0), gp = grid::gpar(lwd=3))) +
    theme(
      axis.line = element_blank(),
      axis.title.x=element_blank(),
      axis.title.y=element_blank(),
      axis.text.x = element_text(color="black", size=fontsize),
      axis.text.y = element_text(color="black", size=fontsize),
      text = element_text(size=fontsize),
      strip.background = element_blank(),
      plot.background = element_blank(),
      plot.margin = unit(c(0.005, .05, 0, 0), "null"),
      panel.border = element_blank(),
      plot.tag = element_text(angle = 90, vjust = 1, size=fontsize),
      plot.tag.position = c(1, .5),
      panel.spacing = unit(c(0, 0, 0, 0), "null"),
      legend.key = element_blank(),
      legend.key.size = unit(.5, "cm"),
      legend.key.height = unit(1, 'cm'), 
      legend.key.width = unit(.75, 'cm'), 
      legend.position="none",
      legend.direction = "horizontal",
      legend.justification = c("center", "top"),
      legend.title=element_blank(),
      legend.text=element_text(size=fontsize, margin = margin(r = 5)),
      legend.margin = margin(0, 0, 0, 0),
      legend.spacing.x = unit(0.1, "cm"),
      legend.spacing.y = unit(0, "cm"),
      legend.box.just = "right",
      legend.box.background = element_blank()
    ) 
}

df=read.csv('csv/sus.csv', sep=",")
condition_order <- c("NS", "MS", "GS", "AS")
df$conditions <- factor(df$conditions, levels = condition_order)

df_ar <- df[df$role == 'AR', ]
df_vr <- df[df$role == 'VR', ]


# stat.test <- df %>% 
#   t_test(sus_score~conditions, p.adjust.method = 'bonferroni') %>%
#   add_significance("p") %>%
#   add_xy_position(x = "conditions")

tukey <- df %>% 
  tukey_hsd(sus_score ~ conditions) %>% 
  add_significance() %>% 
  add_xy_position()

bxp_vr <- custom_boxplot(df_vr, dodge, fontsize, coloring, "remote user") + 
  theme(
    axis.text.x = element_blank(),
    plot.margin = unit(c(0.005, .05, 0.05, 0), "null"),
    plot.tag.position = c(1, .5),
  ) 

bxp_ar <- custom_boxplot(df_ar, dodge, fontsize, coloring, "local user") + 
    theme(plot.tag.position = c(1, .6)) +
    guides(fill = guide_legend(override.aes = list(color = "transparent")))


final_plot <- arrangeGrob(bxp_vr, bxp_ar, nrow = 2, heights = c(.45, .55))
grid.arrange(final_plot)
# saving the final figure
ggsave("out/sus.pdf", final_plot, width = 3.5, height = 6, dpi = 1000)
```