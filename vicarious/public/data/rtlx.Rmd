---
title: "Raw TLX"
author: "jQuery404"
output: html_notebook
---

RTlx calculation


```{r}
# library
library(ggplot2)
library(dplyr)
library(broom)
library(tidyr)
library(stats)

coloring = c("#ffbd67", "#f6dbb8","#94d8e0","#537b7f")
fontsize = 14
dodge = .75
```

#### Quick box-plot and Descriptive stats

```{r}
data=read.csv('csv/nasa_tlx.csv', sep=",")
condition_order <- c("NS", "MS", "GS", "AS")
param_order <- c("Mental", "Physical", "Temporal", "Performance", "Effort", "Frustration", "Overall")
df <- data %>%
  gather(key = "conditions", value = "scores", NS:AS) %>%
  mutate(conditions = factor(conditions, levels = condition_order)) %>%
  mutate(params = factor(params, levels = param_order))

# Assuming df is your data frame
summary_df <- df %>%
  filter(params == "Overall") %>%
  group_by(conditions) %>%
  summarise(min = min(scores),
            lq = quantile(scores, 0.25),
            hq = quantile(scores, 0.75),
            max = max(scores),
            mean = mean(scores),
            median = median(scores),
            sd = sd(scores))

# Print the summary
print(summary_df)

boxplot(scores ~ conditions, data = df, 
        main = "Boxplot Example",
        xlab = "Category",
        ylab = "Value")
# Calculate mean for each category
means <- aggregate(scores ~ conditions, data = df, mean)

# Add mean points
points(x = as.numeric(means$conditions), y = means$scores, pch = 4)
```

#### Normality test

```{r}
data=read.csv('csv/nasa_tlx.csv', sep=",")
condition_order <- c("NS", "MS", "GS", "AS")
df <- data %>%
  gather(key = "conditions", value = "scores", NS:AS) %>%
  mutate(conditions = factor(conditions, levels = condition_order))
result<-shapiro.test(df$scores)

print(paste("Test Statistic (W):", result$statistic, "p=", result$p.value))
print(if (result$p.value > 0.05) "The data follows a normal distribution." else "The data does not follow a normal distribution.")

qqnorm(df$scores)
qqline(df$scores)
```


### Lets plot 
bar plot

```{r}

stat.test <- df %>% 
  group_by(params) %>% 
  wilcox_test(scores~conditions, p.adjust.method = 'BH') %>%
  add_significance("p") %>%
  add_xy_position(x = "params")

bp <- ggbarplot(df, x = "params", y = "scores",
                fill = "conditions", palette = coloring,
                add = "mean_ci", add.params = list(group = "conditions"),
                position = position_dodge(1.15*dodge)) +
      theme_bw() +
      ylim(0, 100)

bp + stat_pvalue_manual(
  stat.test, x = "params",
  hide.ns = TRUE,
  label = "p = {p.adj}",
) +
  theme(axis.line = element_blank(),
        axis.title.x=element_blank(),
        axis.title.y=element_blank(),
        axis.text.x = element_text(color="black", size=fontsize),
        axis.text.y = element_text(color="black", size=fontsize),
        text = element_text(size=fontsize),
        strip.background = element_blank(),
        plot.background = element_blank(),
        plot.margin = unit(c(0.005, .025, 0, 0), "null"),
        panel.border = element_blank(),
        panel.spacing = unit(c(0, 0, 0, 0), "null"),
        legend.position="bottom",
        legend.direction = "horizontal",
        legend.justification = c("center", "top"),
        legend.title=element_blank(),
        legend.text=element_text(size=fontsize),
        legend.box.just = "right",
        legend.box.background = element_blank())

# saving the final figure
ggsave("out/rtlx.pdf", width = 12, height = 6, dpi = 1000)
```
plot 2

```{r}
# df <- df %>%
#   filter(params != "Overall")

stat.test <- df %>% 
  group_by(params) %>% 
  wilcox_test(scores~conditions, p.adjust.method = 'BH') %>%
  add_significance("p") %>%
  add_xy_position(x = "params")

bxp <- ggplot(df, aes(x = params, y = scores)) +
  # geom_hline(yintercept = 44.25926, color = '#ff0000', linetype = 'solid', size = .5) +
  # geom_hline(yintercept = 43.01852, color = '#00ff00', linetype = 'solid', size = .5) +
  # geom_hline(yintercept = 33.94444, color = '#78AEB5', linetype = 'solid', size = .5) +
  # geom_hline(yintercept = 41.61111, color = '#2D4244', linetype = 'solid', size = .5) +
  stat_boxplot(aes(fill = conditions), geom = "errorbar", width = 0.2, position = position_dodge(dodge)) +
  geom_boxplot(aes(fill = conditions), width = dodge, coef = 0, outlier.alpha = 0, show.legend = F) +
  stat_summary(aes(fill = conditions), fun.y = mean,
               geom= "point", shape = 4, size = 2, colour= "black",
               position = position_dodge(width = dodge)) +
  stat_summary(aes(fill = conditions), fun.y = median,
               geom = "crossbar", fatten = .1, width = .9*dodge, color = "black",
               position = position_dodge(width = dodge)) +
  labs(x = NULL, y = NULL) + 
  theme_bw()

bxp + stat_pvalue_manual(stat.test, label = 'p.signif', hide.ns = TRUE, tip.length = 0.02) + 
  scale_fill_manual(name= "conditions", values = coloring) +
  scale_color_manual(name = "conditions", values = coloring) +
  # scale_y_continuous(minor_breaks = seq(0, 8, 1), breaks = seq(1, 8.1, by=1), limits=c(1, 8.1)) + 
  theme(
    axis.line = element_blank(),
    axis.title.x=element_blank(),
    axis.title.y=element_blank(),
    axis.text.x = element_text(color="black", size=fontsize),
    axis.text.y = element_text(color="black", size=fontsize),
    text = element_text(size=fontsize),
    strip.background = element_blank(),
    plot.background = element_blank(),
    plot.margin = unit(c(0.005, .025, 0, 0), "null"),
    panel.border = element_blank(),
    panel.spacing = unit(c(0, 0, 0, 0), "null"),
    legend.key = element_blank(),
    legend.key.size = unit(1, "cm"),
    legend.key.height = unit(1.5, 'cm'), 
    legend.key.width = unit(1, 'cm'),
    legend.position="bottom",
    legend.direction = "horizontal",
    legend.justification = c("center", "top"),
    legend.title=element_blank(),
    legend.text=element_text(size=fontsize),
    legend.box.just = "right",
    legend.box.background = element_blank()
  ) + 
  guides(fill = guide_legend(override.aes = list(color = "transparent")))

# saving the final figure
ggsave("out/rtlx.pdf", width = 10, height = 4, dpi = 1000)
  
```

### -------------------------------------
### Lets find out about Task complexity 


```{r}

data=read.csv('csv/TaskCompletionTime.csv', sep=",")
df <- data %>%
  pivot_longer(
    cols = starts_with("task"),
    names_to = "task",
    values_to = "time"
  ) %>%
  arrange(conditions, task)

# Assuming df is your data frame
summary_df <- df %>%
  group_by(conditions) %>%
  summarise(min = min(time),
            max = max(time),
            mean = mean(time),
            median = median(time),
            sd = sd(time))

# Print the summary
print(summary_df)


condition_order <- c("NS", "MS", "GS", "AS")
df$conditions <- factor(df$conditions, levels = condition_order)
boxplot(time ~ conditions, data = df, 
        main = "Boxplot Example",
        xlab = "Category",
        ylab = "Value")
# Calculate mean for each category
means <- aggregate(time ~ conditions, data = df, mean)

# Add mean points
points(x = as.numeric(means$conditions), y = means$time, pch = 4)
```

```{r}
model <- aov_4(time ~ conditions + (conditions|group), type= 3, data = df)
summary(model)

print('# Perform repeated measures ANOVA with nice()')
modelnice <- nice(model, intercept = TRUE, correction = "GG")

print(modelnice) # ges: generalized eta-squared, measure of effect size indicating the proportion of variance explained by the independent variable.

emmip(model, ~conditions, CIs = TRUE)
```
```{r}
posthoc <- emmeans(model, specs = pairwise ~ conditions, model = "multivariate", adjust = "tukey")
posthoc$emmeans
posthoc$contrasts
```

Extract residual/predicted values
```{r}
new_data <- fitted(model, append = TRUE)
residual_data <- residuals(model, append = TRUE)
new_data$.residuals <- residual_data$.residuals
head(new_data, 20)

describe(new_data$.residuals, type=1)

shapiro.test(new_data$.residuals)

resid_auxpanel(residuals=new_data$.residuals, predicted=new_data$.fitted, smoother = TRUE, qqbands=TRUE, 
               plots=c('resid', 'qq', 'index', 'hist'))
```


```{r}

# stat.test <- df %>% 
#   t_test(sus_score~conditions, p.adjust.method = 'bonferroni') %>%
#   add_significance("p") %>%
#   add_xy_position(x = "conditions")

tukey <- df %>% 
  tukey_hsd(time ~ conditions) %>% 
  add_significance() %>% 
  add_xy_position()

bxp <- ggplot(df, aes(x = conditions, y = time)) + 
  stat_boxplot(aes(fill = conditions), geom = "errorbar", width = 0.25, position = position_dodge(dodge), show.legend = F) +
  geom_boxplot(aes(fill = conditions), width = dodge/2, coef = 0, outlier.alpha = 0, show.legend = F) +
  stat_summary(aes(fill = conditions), fun.y = mean, 
               geom= "point", shape = 4, size = 5, colour= "black", 
               position = position_dodge(width = dodge), show.legend = F) +
  stat_summary(aes(fill = conditions), fun = median,
               geom = "crossbar", fatten = 0, width = .4*dodge, color = "black",
               position = position_dodge(width = dodge), show.legend = T) +
  labs(x = NULL, y = NULL) + 
  theme_bw()

bxp + 
  # stat_pvalue_manual(stat.test, label = 'p.signif', hide.ns = TRUE, tip.length = 0.02) + 
  stat_pvalue_manual(tukey, hide.ns = T) +
  scale_fill_manual(name= "conditions", values = coloring) +
  scale_color_manual(name = "conditions", values = coloring) +
  theme(
    axis.line = element_blank(),
    axis.title.x=element_blank(),
    axis.title.y=element_blank(),
    axis.text.x = element_text(color="black", size=fontsize),
    axis.text.y = element_text(color="black", size=fontsize),
    text = element_text(size=fontsize),
    strip.background = element_blank(),
    plot.background = element_blank(),
    plot.margin = unit(c(0.015, .025, 0, 0), "null"),
    panel.border = element_blank(),
    panel.spacing = unit(c(0, 0, 0, 0), "null"),
    legend.position="bottom",
    legend.direction = "horizontal",
    legend.justification = c("center", "top"),
    legend.key = element_blank(),
    legend.key.size = unit(1, "cm"),
    legend.key.height = unit(1.5, 'cm'), 
    legend.key.width = unit(1, 'cm'), 
    legend.title=element_blank(),
    legend.text=element_text(size=fontsize),
    legend.box.just = "right",
    legend.box.background = element_blank()
  ) + 
  guides(fill = guide_legend(override.aes = list(color = "transparent")))
# saving the final figure
ggsave("out/TaskCompletionTime.pdf", width = 4, height = 4, dpi = 1000)
```


## ANOVA and Bartlett's test

```{r}
# One-Way ANOVA
model <- aov(time ~ task, data = completion_times)
anova_table <- anova(model)
F_val <- anova_table$F[1]
df1 <- anova_table$Df[1]
df2 <- anova_table$Df[2]

# print the results
summary(model)
cat("F(", df1, ", ", df2, ") = ", F_val, "\n")
```

## Bartlett's test

```{r}
bartlett_test <- bartlett.test(time ~ task, data = completion_times)

# Create a data frame to store the test results
test_results <- data.frame(
  statistic = bartlett_test$statistic,
  p.value = bartlett_test$p.value,
  parameter = bartlett_test$parameter
)
test_results
```

## Everything together

```{r}
# Create a string
my_string <- paste(
  "Bartlett's K-squared = ", bartlett_test$statistic, 
  ", df=", bartlett_test$parameter, 
  ", p-value =", bartlett_test$p.value, 
  ", Sigf = ", bartlett_test$p.value < 0.05,
  ", F-stats: ", capture.output(cat("F(", df1, ", ", df2, ") = ", F_val, "\n")))
bartlett_stats <- data.frame(my_string)
bartlett_stats

```


## Save the resulting data frame as a CSV file

```{r}
data <- data.frame(
  category = c("G1", "G2", "G3", "G4", "G5", "G6", "G7", "G8", "G9"),
  value1 = c(20, 30, 15),
  value2 = c(10, 25, 20),
  value3 = c(15, 12, 18),
  value4 = c(20, 30, 15),
  value5 = c(10, 25, 20),
  value6 = c(15, 12, 18),
  value7 = c(20, 30, 15)
)

# Convert data from wide to long format
data_long <- tidyr::pivot_longer(data, cols = starts_with("value"), names_to = "variable", values_to = "value")

p <- ggplot(data_long, aes(x = category, y = value, fill = variable)) +
  geom_bar(stat = "identity", position = "stack") +
  labs(x = "Category", y = "Value") +
  theme_minimal() +
  scale_fill_brewer(palette = "Dark2") +
  coord_flip()

# Create a second data frame with additional values
additional_data <- data.frame(
  category = c("G1", "G2", "G3", "G4", "G5", "G6", "G7", "G8", "G9"),
  additional_value = c(5, 10, 3)
)

# Convert the additional data to long format
additional_data_long <- tidyr::pivot_longer(additional_data, 
                                            cols = starts_with("additional_value"), 
                                            names_to = "variable", 
                                            values_to = "value")

# Add the second bar plot on top of the first one
p <- p +
  geom_bar(data = additional_data_long, aes(x = category, y = value, fill = variable),
           stat = "identity", position = "stack", width = 0.5)  

# Display the plot
p

ggsave("out/ActivityVis.pdf", width = 8, height = 3, dpi = 1000)

```

```{r}
write.csv(df, file = "csv/task_df.csv", row.names = FALSE)

```