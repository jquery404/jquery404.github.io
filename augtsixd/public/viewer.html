<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Viewer</title>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.21.1/axios.min.js"></script>
    <script src="comp-skybox.js"></script>
    <script src="comp-toast.js"></script>
    <script src='viewer.js'></script>  

</head>
<body>

    <a-scene vr-mode-ui="enabled: true">
        <a-assets>
        <img id="grid" src="img/grid.png">
        <img id="sky" src="img/sky.jpg" />

        <a-asset-item id="boy-head-glb" src="model/curious_boy_black_head.glb"></a-asset-item>
        <a-asset-item id="boy-body-glb" src="model/curious_boy_default_body.glb"></a-asset-item>
        <a-asset-item id="boy-hand-l-glb" src="model/man_hand_l.glb"></a-asset-item>
        <a-asset-item id="boy-hand-r-glb" src="model/man_hand_r.glb"></a-asset-item>

        <a-asset-item id="goal1-glb" src="model/model2.glb"></a-asset-item>

        <a-asset-item id="pointer-glb" src="model/pointer.glb"></a-asset-item>
        <a-asset-item id="env_arrow" src="model/env_arrow.obj"></a-asset-item>
        <a-asset-item id="arrow-glb" src="model/arrow.glb"></a-asset-item>
        <!-- Player -->
        <template id="player-template">
            <a-entity></a-entity>
        </template>

        <!-- Avatar -->
        <template id="avatar-template">
            <a-entity class="avatar">
                <a-entity class="nametag" text="value: Hello; align:center;" position="0 0.6 0" rotation="0 180 0" scale="4 4 4"></a-entity>
                <a-entity class="head" gltf-model="#boy-head-glb" scale="1 1 1"></a-entity>
                <a-entity class="body" gltf-model="#boy-body-glb" scale="1 1 1"></a-entity>
            </a-entity>
        </template>

        <!-- Hand -->
        <template id="hand-l-template">
            <a-entity>
            <!-- <a-sphere color="#ffad34" radius=".05"></a-sphere> -->
            <a-entity gltf-model="#boy-hand-l-glb" scale=".08 .08 .08"></a-entity>
            </a-entity>
        </template>

        <template id="hand-r-template">
            <a-entity>
            <a-entity gltf-model="#boy-hand-r-glb" scale=".08 .08 .08"></a-entity>
            </a-entity>
        </template>

        <!-- Hand -->
        <template id="pointer-template">
            <a-entity>
                <a-entity class="pointer" visible="false" gltf-model="#pointer-glb" position="0 0 0" rotation="-90 0 0"></a-entity>
            </a-entity>
        </template>

        <template id="bullet-template">
            <a-entity>
              <a-sphere class="bullet" scale="0.1 0.1 0.1" color="#ff00000"></a-sphere>
            </a-entity>
        </template>
        </a-assets>

        <a-entity id="player" spawn-in-circle="radius:3" networked="template:#player-template;attachTemplateToLocal:false;">
            <a-entity id="playerHead"
                networked="template:#avatar-template;attachTemplateToLocal:false;"
                camera
                camrender="cid: cam"
                position="0 1.8 0" 
                look-controls
                wasd-controls>
                <a-entity class="nametag" visible="false"></a-entity>
            </a-entity>
        
            
            <a-entity id="lhand" 
                laser-controls="hand: left"
                mixin="hud-interactable"
                raycaster="objects: [gui-interactable], .hud; lineColor: #7B98F7; far: 1000" 
                lego-model="legoSrc:#goal1-glb" 
                gun="bulletTemplate:#bullet-template" 
                networked="template:#hand-l-template;attachTemplateToLocal:false;">
                <a-entity id="controller-menu" opacity="0.8">
                    <a-entity id="menu" position="0 .05 0" rotation="0 0 0" scale=".15 .15 .15" layout="type: box; plane: xy; columns: 3; margin: 2; align: center" rotation="0 0 0">
                        <a-box position="0 0 -1" depth=".5" height=".05" width="1" rotation="0 0 0" color="black">
                            <a-text id="menulabel" width="1" position="0 .05 0" value= "Menu..."  align="center" scale="4 4 4" rotation="-90 0 0"></a-text>
                        </a-box>                                        
                        <a-cylinder class="menu-item" src="img/ico_goa.jpg" data-target="paint" color="#FFC65D" radius="0.5" height=".05" opacity=".5" theta-start="0" theta-length="90"></a-cylinder>
                        <a-cylinder class="menu-item clickable" src="img/ico_goa.jpg" data-target="shoot" color="#FFC65D" radius="0.5" height=".05" opacity=".5" theta-start="90" theta-length="90"></a-cylinder>
                        <a-cylinder class="menu-item clickable" src="img/ico_goa.jpg" data-target="lego-goal" color="#FFC65D" radius="0.5" height=".05" opacity=".5" theta-start="180" theta-length="90"></a-cylinder>
                        <a-cylinder class="menu-item" src="img/ico_goa.jpg" data-target="pointer" color="#FFC65D" radius="0.5" height=".05" opacity=".5" theta-start="270" theta-length="90"></a-cylinder>
                        
                    </a-entity>
                </a-entity>
                <a-entity 
                    id="glbtest"
                    gltf-model="#goal1-glb"
                    scale=".05 .05 .05"
                    position="0 .1 0">
                </a-entity>
            </a-entity>
        
            <a-entity id="rhand" 
                painter 
                gun="bulletTemplate:#bullet-template" 
                laser-controls="hand: right" 
                mixin="hud-interactable"
                raycaster="objects: [gui-interactable], .clickable, .hud; lineColor: #7B98F7; far: 1000" 
                networked="template:#hand-r-template;attachTemplateToLocal:false;">
                
                <a-entity id="playerPointer" networked="template:#pointer-template;attachTemplateToLocal:true;">
                    <a-entity class="pointer" visible="false"></a-entity>
                </a-entity>
            </a-entity>
        </a-entity>
        

        <!-- <a-entity id="player" camera position="0 0 0" wasd-controls look-controls></a-entity> -->

        <a-entity position="0 0 0"
        geometry="primitive: plane; width: 10000; height: 10000;" rotation="-90 0 0"
        material="src: #grid; repeat: 10000 10000; transparent: true; metalness:0.6; roughness: 0.4; sphericalEnvMap: #sky;"></a-entity>

        <a-sky set-sky="#sky" rotation="0 0 0"></a-sky>
    </a-scene>
    <h1>Viewer</h1>
    <video autoplay id='video'></video>
    <button id="my-button" style="position: absolute; top:0; z-index:111;">View Stream</button>



    <script src="jquery-latest.min.js"></script>

    <script>
        const menu = document.querySelector("#controller-menu");
        const menulabel = document.querySelector("#menulabel");
        const lhand = document.querySelector("#lhand");
        const rhand = document.querySelector("#rhand"); 
        const menuColor = '#FFC65D'; 
        let selectedMenu = '';
        let prevMenu = '';
        let toggleMenu = ['lego-goal', 'pointer'];
        let isMenuSelected;
        let isMenuHovered;
        let avatarHudPair = [];

        $(lhand).on("triggerdown triggerup", function(e) {
            visibility(menu);
        });

        $(rhand).on("triggerdown", function(e) {
            
            if(isMenuHovered) {
                isMenuSelected = true;
                selectedMenu = menulabel.getAttribute('value');

                let thisMenu = $(`[data-target="${selectedMenu}"]`);

                // toggle buttons
                if(toggleMenu.includes(selectedMenu)){
                    if(thisMenu.hasClass('on')) thisMenu.removeClass('on')
                    else thisMenu.addClass('on');
        
                    if (selectedMenu == 'lego-goal'){
                        lhand.emit("lego-goal");
                    }else if(selectedMenu == 'pointer'){
                        var myPointer = document.querySelectorAll('.pointer');
                        myPointer.forEach(elem => {
                            elem.setAttribute('visible', thisMenu.hasClass('on') ? 'true' : 'false');
                            //.... broadcast pointing
                            const networkedComponent = document.querySelector('#player').getAttribute("networked");
                            if(thisMenu.hasClass('on'))
                                NAF.connection.broadcastDataGuaranteed("pointer-start", networkedComponent.networkId);
                            else
                                NAF.connection.broadcastDataGuaranteed("pointer-close", networkedComponent.networkId);
                            
                        });                    
                    }
                }
                // general buttons
                else {
                    if(prevMenu && prevMenu[0].getAttribute('data-target') !== thisMenu[0].getAttribute('data-target')) {
                        prevMenu.removeClass('on');
                        resetMenuStyle(prevMenu[0]);
                    }
                    thisMenu.addClass('on');
                    prevMenu = thisMenu;
                }
            
            }
            

            if(isMenuSelected && !isMenuHovered){

                switch (selectedMenu) {
                    case 'paint':
                        rhand.setAttribute("painter", {canDraw: true});                    
                        break;

                    case 'shoot':
                        rhand.setAttribute("painter", {canDraw: false});
                        rhand.emit("gun-fire");                    
                        break;

                    default:
                        break;
                }
            }
            
        });


        $(".menu-item").on("raycaster-intersected", function(e) {
            if (!menu.object3D.visible) return;
            let targetEl = this.getAttribute("data-target");
            menulabel.setAttribute('value', targetEl);
            setMenuStyle(this);
            isMenuHovered = true;
        });

        $(".menu-item").on("raycaster-intersected-cleared", function(e) {
            isMenuHovered = false
            if($(this).hasClass('on')) return;

            resetMenuStyle(this);        
        });

        function visibility(el) {
            el.setAttribute("visible", !el.object3D.visible);
        }

        function setMenuStyle(el){
            el.setAttribute('color', '#ff0000');
            el.setAttribute('opacity', '1');
        }

        function resetMenuStyle(el){
            el.setAttribute('color', menuColor);   
            el.setAttribute('opacity', '.5');
        }

    </script>
</body>
</html>